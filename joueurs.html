<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FC Newinn ‚Äî Espace joueurs</title>

  <!-- Reprends tes styles si tu veux (sinon simple) -->
  <style>
    body{margin:0;font-family:system-ui;background:#0b1020;color:#fff}
    .page{max-width:920px;margin:0 auto;padding:24px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:16px;margin:14px 0}
    .btn{cursor:pointer;border:0;border-radius:14px;padding:10px 14px;font-weight:600}
    .btnPrimary{background:#fff;color:#111}
    .btnGhost{background:rgba(255,255,255,.08);color:#fff}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .small{opacity:.85;font-size:14px}
    input{width:100%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;outline:none}
    a{color:#fff}
  </style>
</head>

<body>
  <div class="page">
    <a href="index.html">‚Üê Retour au site</a>

    <h1>Espace joueurs</h1>
    <p class="small">Connexion Google + cl√© ID (uniquement la premi√®re fois).</p>

    <!-- üîí Zone login -->
    <div id="gate" class="card">
      <div class="row">
        <button id="btnGoogle" class="btn btnPrimary" type="button">Se connecter avec Google</button>
        <button id="btnLogout" class="btn btnGhost" type="button" style="display:none;">Se d√©connecter</button>
      </div>

      <div id="who" class="small" style="margin-top:10px;"></div>
      <div id="authError" class="small" style="margin-top:10px; color:#ffb4b4;"></div>


      <!-- cl√© seulement si pas joueur -->
      <div id="keyBox" style="display:none; margin-top:14px;">
        <div class="small" style="margin-bottom:8px;">Premi√®re connexion : entre la cl√© fournie par le staff.</div>
        <input id="playerKey" placeholder="Ex: NEWINN-1A7F-9KQ2" />
        <button id="btnValidateKey" class="btn btnGhost" type="button" style="margin-top:10px;">Valider la cl√©</button>
        <div id="msg" class="small" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- ‚úÖ Options visibles seulement si joueur -->
    <div id="playerArea" class="card" style="display:none;">
      <h2 style="margin:0 0 10px 0;">Options joueurs</h2>
      <div class="small" style="margin-bottom:10px;">Tu peux rajouter ici d‚Äôautres trucs plus tard.</div>

      <div class="row">
        <button class="btn btnPrimary" onclick="window.location.href='entrainement.html'">
          Entra√Ænement (pr√©sence)
        </button>

        <!-- exemples d‚Äôoptions futures -->
        <button class="btn btnGhost" type="button" disabled>
          Stats (bient√¥t)
        </button>
        <button class="btn btnGhost" type="button" disabled>
          Messages (bient√¥t)
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

import {
  getAuth,
  GoogleAuthProvider,
  signInWithRedirect,
  getRedirectResult,
  onAuthStateChanged,
  signOut,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";



    // ‚úÖ COLLE TON firebaseConfig ICI
     const firebaseConfig = {
    apiKey: "AIzaSyAsBNy5Sz5IYQO4pi2y40-dez_oKQxpzMc",
    authDomain: "fc-newinn.firebaseapp.com",
    projectId: "fc-newinn",
   storageBucket: "fc-newinn.appspot.com",
    messagingSenderId: "780192772083",
    appId: "1:780192772083:web:4529bffdae60d88a8c2c86",
    measurementId: "G-567TZ0NDER"
  };

    const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const errEl = document.getElementById("authError");
function showErr(t){
  if (errEl) errEl.textContent = t || "";
}

// Affiche l‚ÄôURL courante (super utile pour voir le domaine r√©el)
showErr("Debug: " + window.location.origin);

// 1) Persistance (si bloqu√©e par navigateur / cookies / mode priv√©, on veut le voir)
setPersistence(auth, browserLocalPersistence)
  .then(() => {
    showErr("Debug: persistence OK ‚Äî " + window.location.origin);
  })
  .catch((e) => {
    console.error("Persistence error", e);
    showErr("‚ùå persistence error: " + (e?.code || e?.message || e));
  });

// 2) R√©sultat du redirect (si domaine non autoris√© => auth/unauthorized-domain ici)
getRedirectResult(auth)
  .then((res) => {
    if (res && res.user) {
      showErr("‚úÖ Redirect OK: " + (res.user.email || res.user.uid));
    }
  })
  .catch((error) => {
    console.error("Erreur redirect Google:", error);
    showErr("‚ùå redirect error: " + (error?.code || error?.message || error));
  });







    const btnGoogle = document.getElementById("btnGoogle");
    const btnLogout = document.getElementById("btnLogout");
    const who = document.getElementById("who");

    const keyBox = document.getElementById("keyBox");
    const playerKey = document.getElementById("playerKey");
    const btnValidateKey = document.getElementById("btnValidateKey");
    const msg = document.getElementById("msg");

    const playerArea = document.getElementById("playerArea");

    async function isPlayer(uid){
      const snap = await getDoc(doc(db, "players", uid));
      return snap.exists();
    }

   async function consumeKeyAndRegister(uid, email, key){
  const keyRef = doc(db, "invites", key);
  const keySnap = await getDoc(keyRef);

  if(!keySnap.exists()) throw new Error("Cl√© inconnue.");
  const data = keySnap.data();
  if(data.used === true) throw new Error("Cl√© d√©j√† utilis√©e.");
  if(!data.playerName) throw new Error("Cl√© sans nom (playerName manquant).");

  // Marquer la cl√© comme utilis√©e (1 seule fois)
  await updateDoc(keyRef, {
    used: true,
    usedBy: uid,
    usedAt: serverTimestamp()
  });

  // Enregistrer le joueur (acc√®s permanent)
  await setDoc(doc(db, "players", uid), {
    email: email || "",
    name: data.playerName,   // ‚úÖ nom venant de la cl√©
    keyId: key,              // ‚úÖ on garde la cl√© utilis√©e
    createdAt: serverTimestamp()
  });
}


   btnGoogle.addEventListener("click", async () => {
  const provider = new GoogleAuthProvider();
  await signInWithRedirect(auth, provider);
});



    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
    });

    btnValidateKey.addEventListener("click", async () => {
      msg.textContent = "";
      const user = auth.currentUser;
      if(!user){ msg.textContent = "‚ö†Ô∏è Connecte-toi d‚Äôabord."; return; }

      const key = (playerKey.value || "").trim();
      if(!key){ msg.textContent = "‚ö†Ô∏è Entre une cl√©."; return; }

      try{
        btnValidateKey.disabled = true;
        msg.textContent = "Validation‚Ä¶";
        await consumeKeyAndRegister(user.uid, user.email, key);
        msg.textContent = "‚úÖ Valid√© !";
        keyBox.style.display = "none";
        playerArea.style.display = "block";
      }catch(e){
        msg.textContent = "‚ùå " + (e.message || "Erreur");
      }finally{
        btnValidateKey.disabled = false;
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        who.textContent = "Non connect√©.";
        btnLogout.style.display = "none";
        playerArea.style.display = "none";
        keyBox.style.display = "none";
        return;
      }

      who.textContent = "Connect√© : " + (user.email || "");
      btnLogout.style.display = "inline-flex";

      const ok = await isPlayer(user.uid);
      if(ok){
  const snap = await getDoc(doc(db, "players", user.uid));
  const pdata = snap.data();
  who.textContent = "Connect√© : " + (pdata?.name ? (pdata.name + " ‚Äî ") : "") + (user.email || "");
  playerArea.style.display = "block";
  keyBox.style.display = "none";
}else{
  who.textContent = "Connect√© : " + (user.email || "");
  playerArea.style.display = "none";
  keyBox.style.display = "block";
  msg.textContent = "Premi√®re connexion : entre ta cl√©.";
}

    });
  </script>
</body>
</html>
